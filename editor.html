import React, { useState, useEffect, useRef } from 'react';
import { 
  Edit3, 
  Type, 
  Image, 
  Palette, 
  Layout, 
  Smartphone, 
  Monitor, 
  Tablet,
  Save,
  Eye,
  Wand2,
  Brain,
  Sparkles,
  MessageSquare,
  Download,
  Settings,
  RotateCcw,
  RotateCw,
  Layers,
  Grid,
  Zap
} from 'lucide-react';

const WebMasterProEditor = () => {
  const [selectedElement, setSelectedElement] = useState(null);
  const [aiMode, setAiMode] = useState(false);
  const [device, setDevice] = useState('desktop');
  const [activePanel, setActivePanel] = useState('sites');
  const [aiChat, setAiChat] = useState([]);
  const [aiInput, setAiInput] = useState('');
  const [isAiProcessing, setIsAiProcessing] = useState(false);
  const [currentSite, setCurrentSite] = useState('medical-aesthetic');
  const [isEditing, setIsEditing] = useState(null);
  const [siteData, setSiteData] = useState({});
  const [selectedFont, setSelectedFont] = useState('Assistant');
  const [selectedColor, setSelectedColor] = useState('#000000');
  const [lastSaved, setLastSaved] = useState(null);

  // Demo sites data
  const demoSites = {
    'medical-aesthetic': {
      name: 'ד"ר מיכל רוזן - רפואה אסתטית',
      category: 'רפואה',
      price: '₪2,800',
      color: '#EC4899',
      content: {
        hero: {
          title: 'ד"ר מיכל רוזן',
          subtitle: 'רפואה אסתטית וטיפולי יופי מתקדמים',
          description: 'מומחית ברפואה אסתטית עם ניסיון של מעל 15 שנה. מתמחה בטיפולי בוטוקס, מילוי קמטים וטיפולי עור מתקדמים.',
          cta: 'קבעי תור לייעוץ חינם'
        },
        services: [
          { title: 'טיפולי בוטוקס', desc: 'הזרקות בוטוקס מקצועיות למניעת הזדקנות', price: '₪800-1,200', icon: '💉' },
          { title: 'מילוי קמטים', desc: 'טיפולי היאלורון איכותיים למילוי וחידוש נפח', price: '₪1,000-2,000', icon: '💋' },
          { title: 'טיפולי עור', desc: 'פילינג כימי ומיקרו-ניידלינג לשיפור מרקם העור', price: '₪600-1,500', icon: '✨' }
        ],
        contact: {
          phone: '03-1234567',
          whatsapp: '052-1234567',
          email: 'info@dr-rosen.co.il',
          address: 'רחוב דיזנגוף 100, תל אביב',
          hours: 'ראשון-חמישי: 9:00-19:00'
        }
      }
    },
    'fitness-pro': {
      name: 'דני פיט - מאמן כושר',
      category: 'כושר',
      price: '₪2,200',
      color: '#EF4444',
      content: {
        hero: {
          title: 'דני פיט',
          subtitle: 'מאמן כושר אישי מקצועי',
          description: 'מאמן כושר מוסמך עם ניסיון של 10+ שנה. מתמחה באימונים אישיים ותוכניות כושר מותאמות.',
          cta: 'התחל את המסע שלך'
        },
        services: [
          { title: 'אימון אישי', desc: 'אימונים אישיים מותאמים לרמתך ולמטרות שלך', price: '₪250 לאימון', icon: '💪' },
          { title: 'תוכניות כושר', desc: 'תוכניות אימון מקצועיות לבית או חדר כושר', price: '₪399 לחודש', icon: '🏠' },
          { title: 'ייעוץ תזונתי', desc: 'תפריטים בריאים ומותאמים אישית', price: '₪199 לחודש', icon: '🥗' }
        ],
        contact: {
          phone: '03-9876543',
          whatsapp: '052-9876543',
          email: 'danny@fitnessco.co.il',
          address: 'מרכז כושר פרימיום, רמת גן',
          hours: 'ראשון-חמישי: 6:00-22:00'
        }
      }
    },
    'law-firm': {
      name: 'משרד ברקוביץ - עורכי דין',
      category: 'משפטי',
      price: '₪2,500',
      color: '#6B7280',
      content: {
        hero: {
          title: 'משרד ברקוביץ',
          subtitle: 'עורכי דין מקצועיים ומנוסים',
          description: 'משרד עורכי דין מוביל עם ניסיון של 25+ שנה. מתמחה בדיני חברות, נדל"ן ומשפחה.',
          cta: 'קבע ייעוץ משפטי'
        },
        services: [
          { title: 'דיני חברות', desc: 'ייעוץ משפטי מקצועי להקמת חברות והסכמים עסקיים', price: 'ייעוץ ללא עלות', icon: '🏢' },
          { title: 'דיני נדל"ן', desc: 'ליווי משפטי מלא בעסקאות קנייה ומכירה', price: 'לפי הסכם', icon: '🏠' },
          { title: 'דיני משפחה', desc: 'טיפול מקצועי ורגיש בענייני גירושין ומשמורת', price: 'ייעוץ ראשוני חינם', icon: '👨‍👩‍👧‍👦' }
        ],
        contact: {
          phone: '03-6666666',
          email: 'office@barkowitz-law.co.il',
          address: 'רחוב הארבעה 12, תל אביב',
          hours: 'ראשון-חמישי: 8:30-17:30'
        }
      }
    }
  };

  // Initialize site data
  useEffect(() => {
    const newSiteData = demoSites[currentSite];
    if (newSiteData) {
      setSiteData(newSiteData);
      setIsEditing(null);
      setSelectedElement(null);
      setAiChat([]);
    }
  }, [currentSite]);

  // Auto-save functionality
  useEffect(() => {
    const saveData = () => {
      if (siteData && Object.keys(siteData).length > 0) {
        localStorage.setItem('webmaster-site-data', JSON.stringify(siteData));
        setLastSaved(new Date());
      }
    };
    
    const timer = setTimeout(saveData, 2000);
    return () => clearTimeout(timer);
  }, [siteData]);

  // Update site content
  const updateContent = (path, value) => {
    setSiteData(prev => {
      const newData = { ...prev };
      const keys = path.split('.');
      let current = newData;
      
      for (let i = 0; i < keys.length - 1; i++) {
        if (!current[keys[i]]) current[keys[i]] = {};
        current = current[keys[i]];
      }
      
      current[keys[keys.length - 1]] = value;
      return newData;
    });
  };

  // Text editing functions
  const startEditing = (elementId) => {
    setIsEditing(elementId);
    setSelectedElement(elementId);
  };

  const stopEditing = () => {
    setIsEditing(null);
  };

  const handleTextChange = (path, value) => {
    updateContent(path, value);
  };

  // AI Chat functionality
  const sendToAI = async () => {
    if (!aiInput.trim() || isAiProcessing) return;
    
    setIsAiProcessing(true);
    const userMessage = aiInput;
    setAiInput('');
    
    setAiChat(prev => [...prev, { type: 'user', content: userMessage }]);
    
    try {
      const currentSiteInfo = siteData;
      const prompt = `אני עובד על עריכת אתר ב-WebMaster Pro עבור "${currentSiteInfo.name}". השאלה/בקשה שלי: ${userMessage}. תן לי תשובה מעשית וספציפית.`;
      
      const response = await window.claude.complete(prompt);
      setAiChat(prev => [...prev, { type: 'ai', content: response }]);
      
    } catch (error) {
      setAiChat(prev => [...prev, { 
        type: 'ai', 
        content: 'מצטער, יש בעיה בחיבור ל-AI. נסה שוב בעוד רגע.' 
      }]);
    }
    
    setIsAiProcessing(false);
  };

  // Device selector component
  const DeviceSelector = () => (
    <div className="flex bg-gray-100 rounded-lg p-1">
      {[
        { id: 'desktop', icon: Monitor },
        { id: 'tablet', icon: Tablet },
        { id: 'mobile', icon: Smartphone }
      ].map(d => (
        <button
          key={d.id}
          onClick={() => setDevice(d.id)}
          className={`flex items-center gap-2 px-3 py-2 rounded-md transition-all ${
            device === d.id ? 'bg-white shadow-sm text-blue-600' : 'text-gray-600 hover:bg-gray-50'
          }`}
        >
          <d.icon size={16} />
          <span className="hidden sm:inline capitalize">{d.id}</span>
        </button>
      ))}
    </div>
  );

  // Editable text component
  const EditableText = ({ path, className, style, placeholder, multiline = false }) => {
    const value = path.split('.').reduce((obj, key) => obj?.[key], siteData) || placeholder;
    const isCurrentlyEditing = isEditing === path;

    if (isCurrentlyEditing) {
      return multiline ? (
        <textarea
          value={value}
          onChange={(e) => handleTextChange(path, e.target.value)}
          onBlur={stopEditing}
          className={`${className} border-2 border-blue-400 bg-white resize-none`}
          style={{ ...style, minHeight: '60px' }}
          autoFocus
          rows={3}
        />
      ) : (
        <input
          value={value}
          onChange={(e) => handleTextChange(path, e.target.value)}
          onBlur={stopEditing}
          className={`${className} border-2 border-blue-400 bg-white`}
          style={style}
          autoFocus
        />
      );
    }

    return (
      <div
        className={`${className} cursor-pointer hover:bg-blue-50 hover:outline hover:outline-2 hover:outline-blue-300 transition-all rounded-sm`}
        style={style}
        onClick={() => startEditing(path)}
        title="לחץ לעריכה"
      >
        {value}
      </div>
    );
  };

  // Preview frame component
  const PreviewFrame = () => {
    const site = siteData;
    if (!site || !site.content) return <div>טוען...</div>;

    return (
      <div 
        className={`
          bg-white rounded-lg shadow-lg transition-all duration-300 mx-auto overflow-auto
          ${device === 'desktop' ? 'w-full h-full' : ''}
          ${device === 'tablet' ? 'w-[768px] h-[600px]' : ''}
          ${device === 'mobile' ? 'w-[375px] h-[600px]' : ''}
        `}
        style={{ minHeight: '500px' }}
      >
        <div className="h-full overflow-y-auto">
          {/* Hero Section */}
          <div 
            className="relative p-8 text-white min-h-[400px] flex flex-col justify-center"
            style={{ 
              background: `linear-gradient(135deg, ${site.color}dd, ${site.color}aa)`
            }}
          >
            <div className="max-w-4xl mx-auto text-center">
              <EditableText
                path="content.hero.title"
                className="text-5xl font-bold mb-4 text-white"
                style={{ fontFamily: selectedFont, textShadow: '2px 2px 4px rgba(0,0,0,0.5)' }}
                placeholder="כותרת ראשית"
              />
              <EditableText
                path="content.hero.subtitle"
                className="text-2xl mb-6 text-white"
                style={{ fontFamily: selectedFont, textShadow: '1px 1px 2px rgba(0,0,0,0.5)' }}
                placeholder="תת כותרת"
              />
              <EditableText
                path="content.hero.description"
                className="text-lg mb-8 max-w-2xl mx-auto text-white"
                style={{ fontFamily: selectedFont, textShadow: '1px 1px 2px rgba(0,0,0,0.5)' }}
                placeholder="תיאור קצר"
                multiline={true}
              />
              <EditableText
                path="content.hero.cta"
                className="inline-block px-8 py-4 bg-white text-black font-bold rounded-full text-xl hover:scale-105 transition-transform shadow-lg"
                style={{ fontFamily: selectedFont, color: site.color }}
                placeholder="קריאה לפעולה"
              />
            </div>
          </div>

          {/* Services Section */}
          <div className="py-16 px-8">
            <div className="max-w-6xl mx-auto">
              <h3 className="text-3xl font-bold text-center mb-12" style={{ color: site.color, fontFamily: selectedFont }}>
                השירותים שלנו
              </h3>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                {site.content.services?.map((service, i) => (
                  <div key={i} className="bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow">
                    <div 
                      className="w-16 h-16 rounded-full mb-4 mx-auto flex items-center justify-center text-2xl"
                      style={{ backgroundColor: `${site.color}22` }}
                    >
                      {service.icon || '⭐'}
                    </div>
                    <EditableText
                      path={`content.services.${i}.title`}
                      className="font-bold text-center mb-2"
                      style={{ fontFamily: selectedFont }}
                      placeholder={`שירות ${i + 1}`}
                    />
                    <EditableText
                      path={`content.services.${i}.desc`}
                      className="text-gray-600 text-center text-sm mb-3"
                      style={{ fontFamily: selectedFont }}
                      placeholder="תיאור השירות"
                      multiline={true}
                    />
                    {service.price && (
                      <div className="text-center">
                        <span className="text-lg font-bold" style={{ color: site.color }}>
                          {service.price}
                        </span>
                      </div>
                    )}
                  </div>
                ))}
              </div>
            </div>
          </div>

          {/* Contact Section */}
          <div className="py-16 px-8 bg-gray-100">
            <div className="max-w-4xl mx-auto text-center">
              <h3 className="text-3xl font-bold mb-8" style={{ color: site.color, fontFamily: selectedFont }}>
                צור קשר
              </h3>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                {site.content.contact && (
                  <>
                    <div className="bg-white p-6 rounded-lg shadow-md">
                      <div className="text-2xl mb-3">📞</div>
                      <h4 className="font-bold mb-2">טלפון</h4>
                      <p className="text-gray-600">{site.content.contact.phone}</p>
                    </div>
                    <div className="bg-white p-6 rounded-lg shadow-md">
                      <div className="text-2xl mb-3">📧</div>
                      <h4 className="font-bold mb-2">אימייל</h4>
                      <p className="text-gray-600">{site.content.contact.email}</p>
                    </div>
                    <div className="bg-white p-6 rounded-lg shadow-md">
                      <div className="text-2xl mb-3">📍</div>
                      <h4 className="font-bold mb-2">כתובת</h4>
                      <p className="text-gray-600">{site.content.contact.address}</p>
                    </div>
                    <div className="bg-white p-6 rounded-lg shadow-md">
                      <div className="text-2xl mb-3">🕒</div>
                      <h4 className="font-bold mb-2">שעות פעילות</h4>
                      <p className="text-gray-600">{site.content.contact.hours}</p>
                    </div>
                  </>
                )}
              </div>
              
              {/* WhatsApp Button */}
              {site.content.contact?.whatsapp && (
                <div className="mt-12">
                  <button 
                    className="bg-green-500 hover:bg-green-600 text-white px-8 py-4 rounded-full text-lg font-bold transition-colors shadow-lg"
                    onClick={() => window.open(`https://wa.me/972${site.content.contact.whatsapp.replace(/[^0-9]/g, '')}`, '_blank')}
                  >
                    💬 שלח הודעה בווטסאפ
                  </button>
                </div>
              )}
            </div>
          </div>

          {/* Footer */}
          <footer className="bg-gray-800 text-white py-8 px-8">
            <div className="max-w-4xl mx-auto text-center">
              <h4 className="text-xl font-bold mb-4" style={{ fontFamily: selectedFont }}>
                {site.content.hero?.title || site.name}
              </h4>
              <p className="text-gray-300 mb-4" style={{ fontFamily: selectedFont }}>
                {site.content.hero?.subtitle || 'שירות מקצועי ואמין'}
              </p>
              <div className="text-sm text-gray-400">
                © 2025 כל הזכויות שמורות | עוצב ונבנה עם ❤️ על ידי WebMaster Pro
              </div>
            </div>
          </footer>
        </div>
      </div>
    );
  };

  return (
    <div className="min-h-screen bg-gray-50" dir="rtl">
      {/* Top Toolbar */}
      <div className="bg-white border-b border-gray-200 px-6 py-4">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-4">
            <div className="flex items-center gap-2">
              <Wand2 className="text-purple-600" size={24} />
              <span className="font-bold text-xl">WebMaster Pro</span>
              <span className="text-sm bg-purple-100 text-purple-600 px-2 py-1 rounded-full">
                {Object.keys(demoSites).length} אתרים
              </span>
            </div>
            
            <select 
              value={currentSite}
              onChange={(e) => setCurrentSite(e.target.value)}
              className="px-3 py-2 border border-gray-300 rounded-lg bg-white min-w-[250px]"
            >
              {Object.entries(demoSites).map(([key, site]) => (
                <option key={key} value={key}>
                  {site.name} • {site.price}
                </option>
              ))}
            </select>
          </div>

          <div className="flex items-center gap-4">
            <DeviceSelector />
            
            <button
              onClick={() => setAiMode(!aiMode)}
              className={`flex items-center gap-2 px-4 py-2 rounded-lg transition-all ${
                aiMode ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white shadow-lg' : 'bg-gray-100 text-gray-700'
              }`}
            >
              <Brain size={16} />
              AI עוזר
            </button>

            <button 
              className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
              onClick={() => setLastSaved(new Date())}
            >
              <Save size={16} />
              שמור
            </button>
          </div>
        </div>
      </div>

      <div className="flex h-[calc(100vh-73px)]">
        {/* Left Panel */}
        <div className="w-80 bg-white border-l border-gray-200 overflow-y-auto">
          <div className="p-4">
            <h3 className="font-bold text-lg mb-4 flex items-center gap-2">
              <Settings size={20} />
              כלים בסיסיים
            </h3>
            
            <div className="space-y-4">
              <div>
                <h4 className="font-medium mb-2">בחירת פונט</h4>
                <select 
                  value={selectedFont}
                  onChange={(e) => setSelectedFont(e.target.value)}
                  className="w-full p-2 border border-gray-300 rounded-lg"
                >
                  <option value="Assistant">Assistant - עברית מודרני</option>
                  <option value="Heebo">Heebo - עברית נקי</option>
                  <option value="Rubik">Rubik - עברית עגול</option>
                  <option value="Open Sans">Open Sans - אנגלית קלאסי</option>
                </select>
              </div>

              <div>
                <h4 className="font-medium mb-2">צבע טקסט</h4>
                <input
                  type="color"
                  value={selectedColor}
                  onChange={(e) => setSelectedColor(e.target.value)}
                  className="w-full h-10 border border-gray-300 rounded-lg"
                />
              </div>

              <div>
                <h4 className="font-medium mb-2">רשימת אתרים</h4>
                {Object.entries(demoSites).map(([key, site]) => (
                  <div
                    key={key}
                    className={`p-2 mb-2 rounded-lg cursor-pointer transition-colors ${
                      currentSite === key ? 'bg-blue-100 border border-blue-300' : 'bg-gray-50 hover:bg-gray-100'
                    }`}
                    onClick={() => setCurrentSite(key)}
                  >
                    <div className="font-medium text-sm">{site.name}</div>
                    <div className="text-xs text-gray-500">{site.category} • {site.price}</div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        </div>

        {/* Main Workspace */}
        <div className="flex-1 flex flex-col">
          <div className="flex-1 p-6 overflow-auto">
            <div className="h-full flex items-center justify-center">
              <PreviewFrame />
            </div>
          </div>

          {/* Bottom Status Bar */}
          <div className="bg-white border-t border-gray-200 px-6 py-3">
            <div className="flex items-center justify-between text-sm text-gray-600">
              <div>
                {isEditing ? (
                  <span className="text-blue-600 font-medium">🖊️ עורך: {isEditing}</span>
                ) : (
                  <span>💡 לחץ על טקסט כלשהו כדי לערוך אותו</span>
                )}
              </div>
              <div className="flex items-center gap-4">
                {lastSaved ? (
                  <>
                    <div className="w-2 h-2 bg-green-400 rounded-full"></div>
                    <span>נשמר: {lastSaved.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' })}</span>
                  </>
                ) : (
                  <span>אדיטור פעיל</span>
                )}
              </div>
            </div>
          </div>
        </div>

        {/* Right Panel - AI Assistant */}
        {aiMode && (
          <div className="w-80 bg-gradient-to-b from-purple-50 to-pink-50 border-r border-purple-200 flex flex-col">
            <div className="p-4 border-b border-purple-200">
              <h3 className="font-bold text-lg mb-2 flex items-center gap-2 text-purple-800">
                <Brain size={20} />
                AI עוזר מתקדם
              </h3>
              <p className="text-sm text-purple-600">
                שאל אותי כל שאלה על עיצוב, תוכן או קוד
              </p>
            </div>

            {/* Chat Area */}
            <div className="flex-1 flex flex-col">
              <div className="flex-1 p-4 overflow-y-auto space-y-3">
                {aiChat.length === 0 && (
                  <div className="text-center text-gray-500 mt-8">
                    <Sparkles size={32} className="mx-auto mb-3 text-purple-400" />
                    <p className="font-medium mb-2">שלום! אני עוזר ה-AI 🤖</p>
                    <p className="text-sm">עובד על <strong>{siteData.name}</strong></p>
                  </div>
                )}
                
                {aiChat.map((message, index) => (
                  <div
                    key={index}
                    className={`p-3 rounded-lg ${
                      message.type === 'user'
                        ? 'bg-blue-100 text-blue-800 mr-4'
                        : 'bg-white text-gray-800 ml-4 border border-purple-100'
                    }`}
                  >
                    {message.content}
                  </div>
                ))}
                
                {isAiProcessing && (
                  <div className="bg-white p-3 rounded-lg ml-4 border border-purple-100">
                    <div className="flex items-center gap-2">
                      <div className="animate-spin w-4 h-4 border-2 border-purple-600 border-t-transparent rounded-full"></div>
                      <span>AI חושב...</span>
                    </div>
                  </div>
                )}
              </div>

              {/* Input Area */}
              <div className="p-4 border-t border-purple-200">
                <div className="flex gap-2">
                  <textarea
                    value={aiInput}
                    onChange={(e) => setAiInput(e.target.value)}
                    placeholder="שאל אותי כל שאלה..."
                    className="flex-1 p-3 border border-purple-200 rounded-lg resize-none focus:border-purple-400 focus:ring-2 focus:ring-purple-200 focus:outline-none"
                    rows={2}
                    onKeyDown={(e) => {
                      if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendToAI();
                      }
                    }}
                  />
                  <button
                    onClick={sendToAI}
                    disabled={isAiProcessing || !aiInput.trim()}
                    className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                  >
                    <MessageSquare size={16} />
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

export default WebMasterProEditor;
