<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebMaster Pro Ultimate - Editor</title>
  <!-- GrapesJS CSS -->
  <link href="https://unpkg.com/grapesjs/dist/css/grapes.min.css" rel="stylesheet"/>
  <!-- Tailwind for UI around GrapesJS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body, html { height: 100%; margin: 0; }
    #gjs { height: calc(100vh - 64px); }
    header { height: 64px; }
  </style>
</head>
<body class="flex flex-col">
  <!-- Top Bar -->
  <header class="flex items-center justify-between px-6 bg-gradient-to-r from-purple-700 to-indigo-600 text-white">
    <div class="flex items-center space-x-4">
      <h1 class="text-xl font-bold">WebMaster Pro Ultimate Editor</h1>
      <select id="siteSelect" class="rounded px-2 py-1 text-black">
        <option value="">בחר דמו</option>
        <option value="law-firm.html">עורך דין</option>
        <option value="fitness-co.html">מאמן כושר</option>
        <option value="yoga-studio.html">יוגה</option>
        <option value="tutor.html">מורה פרטית</option>
        <option value="aesthetic-clinic.html">קליניקה</option>
      </select>
      <button id="loadBtn" class="bg-green-500 hover:bg-green-600 px-3 py-1 rounded">טען</button>
    </div>
    <div class="flex items-center space-x-4">
      <button id="saveBtn" class="bg-yellow-400 hover:bg-yellow-500 px-3 py-1 rounded">שמור</button>
      <button id="previewBtn" class="bg-blue-500 hover:bg-blue-600 px-3 py-1 rounded">תצוגה</button>
      <button id="publishBtn" class="bg-red-500 hover:bg-red-600 px-3 py-1 rounded">פרסם</button>
    </div>
  </header>

  <!-- GrapesJS Container -->
  <div id="gjs"></div>

  <!-- Scripts -->
  <script src="https://unpkg.com/grapesjs"></script>
  <script>
    let editor;
    document.getElementById('loadBtn').onclick = () => {
      const page = document.getElementById('siteSelect').value;
      if (!page) return alert('בחר דמו לפני טעינה');
      fetch(`/websites/${page}`)
        .then(res => res.text())
        .then(html => {
          if (editor) editor.destroy();
          editor = grapesjs.init({
            container: '#gjs',
            fromElement: false,
            height: '100%',
            width: 'auto',
            storageManager: false,
            panels: { defaults: [] },
            blockManager: {
              appendTo: '#gjs',
              blocks: [
                { id: 'section', label: 'Section', content: '<section style="padding:20px;"><h2>Section</h2></section>' },
                { id: 'text', label: 'Text', content: '<p>Insert your text here</p>' },
                { id: 'image', label: 'Image', content: '<img src="https://via.placeholder.com/350x150" />' },
                { id: 'video', label: 'Video', content: '<video controls><source src="" /></video>' }
              ]
            },
            styleManager: { sectors: [] },
            assetManager: { embedAsBase64: true },
            commands: {
              defaults: []
            }
          });
          editor.setComponents(html);
          editor.Panels.removeButton('options', 'export-template');
          editor.Commands.add('save-db', {
            run: editor => {
              const content = editor.getHtml() + '<style>' + editor.getCss() + '</style>';
              fetch(`/api/websites/${page}/save`, {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ content })
              }).then(()=> alert('נשמר בהצלחה'));
            }
          });
          document.getElementById('saveBtn').onclick = () => editor.runCommand('save-db');
          document.getElementById('previewBtn').onclick = () => window.open(`/websites/${page}`, '_blank');
          document.getElementById('publishBtn').onclick = () => {
            fetch(`/api/websites/${page}/publish`, { method:'POST' })
              .then(()=> alert('פורסם בהצלחה'));
          };
        });
    };
  </script>
</body>
</html>
